<script>
(async function(){
  const screenLogin = document.getElementById('screen-login');
  const screenApp   = document.getElementById('screen-app');
  const formLogin   = document.getElementById('form-login');
  const btnLogout   = document.getElementById('btn-logout');

  // helper pour afficher l'app ou l'écran login
  function showApp() { screenLogin.hidden = true; screenApp.hidden = false; }
  function showLogin(){ screenLogin.hidden = false; screenApp.hidden = true; }

  // 1) Check auth on load (cookie sent automatically)
  try {
    const res = await fetch('/api/me', { credentials: 'same-origin' });
    if (res.ok) {
      // user authenticated -> show app
      showApp();
    } else {
      // not authed
      showLogin();
    }
  } catch (err) {
    console.warn('auth check failed', err);
    showLogin();
  }

  // 2) Login form -> POST /api/login (credentials included)
  formLogin?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(formLogin);
    const body = {
      email: (fd.get('email') || '').toString().trim(),
      password: (fd.get('password') || '').toString()
    };
    if (!body.email || !body.password) {
      alert('Merci de renseigner email et mot de passe.');
      return;
    }

    try {
      const r = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
        credentials: 'same-origin' // <- indispensable pour que le navigateur stocke le cookie httpOnly
      });
      const d = await r.json().catch(()=>({}));
      if (r.ok) {
        // login ok -> show app and navigate to dashboard
        showApp();
        location.hash = '#/dashboard';
      } else {
        alert(d.error || 'Identifiants invalides');
      }
    } catch (err) {
      console.error('login error', err);
      alert('Erreur réseau, réessaye.');
    }
  });

  // 3) Logout -> call server to clear cookie, then show login
  btnLogout?.addEventListener('click', async () => {
    try {
      await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
    } catch (err) { /* ignore */ }
    showLogin();
    // reset route
    location.hash = '';
  });

})();
</script>
