<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générer des Messages - Prospection IA</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 fixed h-full">
            <div class="flex items-center p-4">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 24 24'%3E%3Cpath fill='%234F46E5' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8z'/%3E%3C/svg%3E" alt="Logo" class="h-8 w-8">
                <span class="ml-3 text-lg font-semibold text-gray-900">Prospection IA</span>
            </div>
            
            <nav class="mt-6 px-4 space-y-1">
                <a href="/app/dashboard" class="flex items-center px-4 py-2 text-gray-600 rounded-md hover:bg-gray-50 group">
                    <svg class="mr-3 h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    Dashboard
                </a>
                <a href="/app/import" class="flex items-center px-4 py-2 text-gray-600 rounded-md hover:bg-gray-50 group">
                    <svg class="mr-3 h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Import Contacts
                </a>
                <a href="/app/generate" class="flex items-center px-4 py-2 text-blue-600 bg-blue-50 rounded-md group">
                    <svg class="mr-3 h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                    Generate Messages
                </a>
                <a href="/app/history" class="flex items-center px-4 py-2 text-gray-600 rounded-md hover:bg-gray-50 group">
                    <svg class="mr-3 h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    History
                </a>
                <a href="/app/settings" class="flex items-center px-4 py-2 text-gray-600 rounded-md hover:bg-gray-50 group">
                    <svg class="mr-3 h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Settings
                </a>
            </nav>
        </aside>

        <!-- Main content -->
        <main class="ml-64 flex-1 p-8">
            <div class="max-w-6xl mx-auto space-y-8">
                <header>
                    <h1 class="text-2xl font-bold text-gray-900">Générer un message personnalisé</h1>
                    <p class="mt-2 text-sm text-gray-600">Sélectionnez un contact et laissez l'IA créer un message adapté en quelques secondes.</p>
                </header>

                <div class="grid grid-cols-1 gap-8 lg:grid-cols-5">
                    <section class="lg:col-span-3 space-y-6">
                        <div class="bg-white rounded-lg shadow p-6 space-y-4">
                            <h2 class="text-lg font-semibold text-gray-900">Paramètres du message</h2>
                            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Nom du contact</label>
                                    <input id="contactName" type="text" placeholder="ex: Marie Dubois" class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Entreprise</label>
                                    <input id="company" type="text" placeholder="ex: TechLabs" class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Objectif</label>
                                    <select id="objective" class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                                        <option value="Prise de rendez-vous">Prise de rendez-vous</option>
                                        <option value="Relance">Relance</option>
                                        <option value="Présentation produit">Présentation produit</option>
                                        <option value="Démo">Démo</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Ton du message</label>
                                    <select id="tone" class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                                        <option value="Professionnel &amp; cordial">Professionnel &amp; cordial</option>
                                        <option value="Convaincant">Convaincant</option>
                                        <option value="Informel">Informel</option>
                                        <option value="Direct &amp; synthétique">Direct &amp; synthétique</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Points clés à mentionner</label>
                                    <div class="mt-2 flex flex-wrap gap-2" id="highlights">
                                        <button type="button" data-highlight="Succès récent du client" class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">Succès récent du client</button>
                                        <button type="button" data-highlight="Cas d'usage SaaS" class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">Cas d'usage SaaS</button>
                                        <button type="button" data-highlight="Invitation démo" class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">Invitation démo</button>
                                        <button type="button" data-highlight="Offre limitée" class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">Offre limitée</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow p-6 space-y-4">
                            <h2 class="text-lg font-semibold text-gray-900">Instructions additionnelles</h2>
                            <textarea id="context" rows="5" class="w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2" placeholder="Ajoutez un contexte spécifique, des contraintes ou des informations à inclure."></textarea>
                            <div class="flex justify-end gap-3">
                                <button id="toggleAI" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    <span id="aiToggleText">Utiliser IA (OpenAI)</span>
                                </button>
                                <button id="generateBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                    <span id="generateBtnText">Générer le message</span>
                                </button>
                            </div>
                        </div>
                    </section>

                    <aside class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-semibold text-gray-900">Aperçu</h2>
                                <span id="statusBadge" class="text-xs font-medium text-gray-600 bg-gray-100 px-2 py-1 rounded-full">Prêt</span>
                            </div>
                            <div id="preview" class="mt-4 space-y-4 text-sm text-gray-700 leading-6">
                                <p class="text-gray-400">En attente de génération...</p>
                            </div>
                            <div class="mt-6 flex justify-between text-xs text-gray-500">
                                <span id="timestamp">—</span>
                                <button id="copyBtn" class="text-indigo-600 hover:text-indigo-500">Copier</button>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow p-6 space-y-4">
                            <h3 class="text-sm font-semibold text-gray-900 uppercase tracking-wide">Templates rapides</h3>
                            <div class="space-y-3">
                                <button class="template-btn w-full text-left px-4 py-3 border border-gray-200 rounded-lg hover:border-indigo-400">
                                    <span class="block text-sm font-medium text-gray-900">Relance post-webinar</span>
                                    <span class="block text-xs text-gray-500">Recontacter les inscrits n'ayant pas réservé de démo.</span>
                                </button>
                                <button class="template-btn w-full text-left px-4 py-3 border border-gray-200 rounded-lg hover:border-indigo-400">
                                    <span class="block text-sm font-medium text-gray-900">Cold outreach VC</span>
                                    <span class="block text-xs text-gray-500">Pitch court orienté levée de fonds.</span>
                                </button>
                                <button class="template-btn w-full text-left px-4 py-3 border border-gray-200 rounded-lg hover:border-indigo-400">
                                    <span class="block text-sm font-medium text-gray-900">Annonce produit</span>
                                    <span class="block text-xs text-gray-500">Mettre en avant une nouvelle fonctionnalité clé.</span>
                                </button>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        </main>
    </div>

    <script>
        let useAI = true;
        let selectedHighlights = [];
        let generatedContent = '';

        // Toggle AI
        document.getElementById('toggleAI').addEventListener('click', () => {
            useAI = !useAI;
            const btn = document.getElementById('toggleAI');
            const text = document.getElementById('aiToggleText');
            if (useAI) {
                btn.classList.remove('bg-red-50', 'text-red-700');
                btn.classList.add('hover:bg-gray-50');
                text.textContent = 'Utiliser IA (OpenAI)';
            } else {
                btn.classList.add('bg-red-50', 'text-red-700');
                btn.classList.remove('hover:bg-gray-50');
                text.textContent = 'Mode template';
            }
        });

        // Toggle highlights
        document.querySelectorAll('#highlights button').forEach(btn => {
            btn.addEventListener('click', () => {
                const highlight = btn.dataset.highlight;
                if (selectedHighlights.includes(highlight)) {
                    selectedHighlights = selectedHighlights.filter(h => h !== highlight);
                    btn.classList.remove('bg-indigo-50', 'text-indigo-600');
                    btn.classList.add('bg-gray-100', 'text-gray-700');
                } else {
                    selectedHighlights.push(highlight);
                    btn.classList.add('bg-indigo-50', 'text-indigo-600');
                    btn.classList.remove('bg-gray-100', 'text-gray-700');
                }
            });
        });

        // Generate message
        document.getElementById('generateBtn').addEventListener('click', async () => {
            const name = document.getElementById('contactName').value.trim();
            const company = document.getElementById('company').value.trim();
            const objective = document.getElementById('objective').value;
            const tone = document.getElementById('tone').value;
            const context = document.getElementById('context').value.trim();

            if (!name || !company) {
                alert('Veuillez remplir le nom du contact et l\'entreprise');
                return;
            }

            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('generateBtnText');
            const statusBadge = document.getElementById('statusBadge');
            
            btn.disabled = true;
            btnText.textContent = 'Génération en cours...';
            statusBadge.textContent = 'Génération...';

            try {
                const response = await fetch('/api/messages/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name,
                        company,
                        tone,
                        objective,
                        highlights: selectedHighlights,
                        additionalContext: context,
                        useAI
                    })
                });

                const data = await response.json();
                
                if (data.ok && data.message) {
                    generatedContent = data.message.content;
                    const preview = document.getElementById('preview');
                    preview.innerHTML = `<p>${generatedContent.split('\n\n').map(p => p.replace(/\n/g, '<br>')).join('</p><p>')}</p>`;
                    
                    const timestamp = document.getElementById('timestamp');
                    const now = new Date();
                    timestamp.textContent = `Généré à ${now.toLocaleTimeString('fr-FR')}`;
                    
                    statusBadge.textContent = 'Généré';
                    statusBadge.classList.remove('text-gray-600', 'bg-gray-100');
                    statusBadge.classList.add('text-green-600', 'bg-green-100');
                } else {
                    alert(`Erreur: ${data.error || 'Impossible de générer le message'}`);
                    statusBadge.textContent = 'Erreur';
                    statusBadge.classList.remove('text-gray-600', 'bg-gray-100');
                    statusBadge.classList.add('text-red-600', 'bg-red-100');
                }
            } catch (error) {
                console.error(error);
                alert('Erreur serveur: ' + error.message);
                statusBadge.textContent = 'Erreur';
                statusBadge.classList.remove('text-gray-600', 'bg-gray-100');
                statusBadge.classList.add('text-red-600', 'bg-red-100');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Générer le message';
            }
        });

        // Copy message
        document.getElementById('copyBtn').addEventListener('click', () => {
            if (generatedContent) {
                navigator.clipboard.writeText(generatedContent).then(() => {
                    const btn = document.getElementById('copyBtn');
                    const originalText = btn.textContent;
                    btn.textContent = 'Copié !';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                });
            }
        });
    </script>
</body>
</html>