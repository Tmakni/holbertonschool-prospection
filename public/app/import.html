<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envoyer un Email - Prospection IA</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex">
        <aside class="w-64 bg-white border-r border-gray-200 fixed h-full">
            <div class="flex items-center p-4">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 24 24'%3E%3Cpath fill='%234F46E5' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8z'/%3E%3C/svg%3E" alt="Logo" class="h-8 w-8">
                <span class="ml-3 text-lg font-semibold text-gray-900">Prospection IA</span>
            </div>
            <nav class="mt-6 px-4 space-y-1">
                <a href="/app/dashboard" class="flex items-center px-4 py-2 text-gray-600 rounded-md hover:bg-gray-50">
                    <svg class="mr-3 h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    Dashboard
                </a>
                <a href="/app/import" class="flex items-center px-4 py-2 text-blue-600 bg-blue-50 rounded-md">
                    <svg class="mr-3 h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    Envoyer Email
                </a>
                <a href="/app/generate" class="flex items-center px-4 py-2 text-gray-600 rounded-md hover:bg-gray-50">
                    <svg class="mr-3 h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                    Generate
                </a>
                <a href="/app/history" class="flex items-center px-4 py-2 text-gray-600 rounded-md hover:bg-gray-50">
                    <svg class="mr-3 h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    History
                </a>
            </nav>
        </aside>

        <main class="ml-64 flex-1 p-8">
            <div class="max-w-3xl mx-auto">
                <div class="mb-8">
                    <h1 class="text-2xl font-bold text-gray-900">Envoyer un Email</h1>
                    <p class="mt-1 text-sm text-gray-600">Envoyez vos messages personnalis√©s via Gmail API.</p>
                </div>

                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-medium mb-4">üì® S√©lectionner un message g√©n√©r√©</h3>
                    <select id="messageSelect" class="w-full border rounded-md px-3 py-2 mb-2">
                        <option value="">-- Charger un message --</option>
                    </select>
                    <p class="text-xs text-gray-500" id="messageCount">Chargement...</p>
                    <div id="messagePreview" class="hidden bg-gray-50 border rounded-md p-4 mt-4">
                        <div class="text-sm whitespace-pre-wrap" id="messagePreviewContent"></div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium mb-4">‚úâÔ∏è Formulaire d'envoi</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Message</label>
                            <textarea id="emailMessage" rows="6" placeholder="Votre message..." class="w-full border rounded-md px-3 py-2"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Email destinataire</label>
                            <input id="recipientEmail" type="email" placeholder="exemple@email.com" class="w-full border rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Objet</label>
                            <input id="emailSubject" type="text" placeholder="Objet de votre email" class="w-full border rounded-md px-3 py-2">
                        </div>
                        <button onclick="sendEmail()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                            üìß Envoyer via Gmail
                        </button>
                    </div>
                    <div id="uploadStatus" style="display:none" class="mt-4">
                        <div id="statusMessage" class="rounded p-4"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let generatedMessages = [];
        
        async function loadGeneratedMessages() {
            try {
                const res = await fetch('/api/messages', { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    generatedMessages = data.messages || [];
                    const messageSelect = document.getElementById('messageSelect');
                    const messageCount = document.getElementById('messageCount');
                    
                    if (generatedMessages.length === 0) {
                        messageCount.textContent = 'Aucun message disponible';
                        messageCount.classList.add('text-gray-500');
                    } else {
                        messageCount.textContent = generatedMessages.length + ' message(s) disponible(s)';
                        messageCount.classList.add('text-green-600');
                        
                        generatedMessages.forEach((msg, idx) => {
                            const option = document.createElement('option');
                            option.value = idx;
                            const preview = msg.content.substring(0, 60) + '...';
                            option.textContent = preview;
                            messageSelect.appendChild(option);
                        });
                    }
                }
            } catch (err) {
                console.error('Erreur:', err);
                document.getElementById('messageCount').textContent = 'Erreur chargement';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadGeneratedMessages();
            
            document.getElementById('messageSelect').addEventListener('change', (e) => {
                const idx = e.target.value;
                if (idx === '') {
                    document.getElementById('messagePreview').classList.add('hidden');
                    return;
                }
                
                const msg = generatedMessages[parseInt(idx)];
                document.getElementById('messagePreview').classList.remove('hidden');
                document.getElementById('messagePreviewContent').textContent = msg.content;
                document.getElementById('emailMessage').value = msg.content;
            });
        });
        
        async function sendEmail() {
            const message = document.getElementById('emailMessage').value.trim();
            const recipientEmail = document.getElementById('recipientEmail').value.trim();
            const emailSubject = document.getElementById('emailSubject').value.trim();
            
            if (!message) {
                showStatus('error', '‚ùå Veuillez entrer un message');
                return;
            }
            if (!recipientEmail) {
                showStatus('error', '‚ùå Veuillez entrer un email destinataire');
                return;
            }
            if (!emailSubject) {
                showStatus('error', '‚ùå Veuillez entrer un objet');
                return;
            }
            
            showStatus('info', 'üì§ Envoi en cours...');
            
            try {
                const res = await fetch('/api/emails/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        to: recipientEmail, 
                        subject: emailSubject, 
                        message: message 
                    })
                });
                
                const isJson = res.headers.get('content-type')?.includes('application/json');
                const data = isJson ? await res.json() : { ok: false, error: await res.text() };
                
                if (res.ok && data.ok) {
                    showStatus('success', '‚úÖ Email envoy√© avec succ√®s √† ' + recipientEmail);
                    document.getElementById('recipientEmail').value = '';
                    document.getElementById('emailSubject').value = '';
                    document.getElementById('emailMessage').value = '';
                    document.getElementById('messageSelect').value = '';
                    document.getElementById('messagePreview').classList.add('hidden');
                } else {
                    showStatus('error', '‚ùå Erreur: ' + (data.error || '√âchec de l\'envoi'));
                }
            } catch (err) {
                console.error('Erreur:', err);
                showStatus('error', '‚ùå Erreur r√©seau: ' + err.message);
            }
        }
        
        function showStatus(type, message) {
            const statusDiv = document.getElementById('uploadStatus');
            const statusMessage = document.getElementById('statusMessage');
            
            let className = 'rounded p-4 ';
            if (type === 'success') {
                className += 'bg-green-50 border border-green-200 text-green-800';
            } else if (type === 'info') {
                className += 'bg-blue-50 border border-blue-200 text-blue-800';
            } else {
                className += 'bg-red-50 border border-red-200 text-red-800';
            }
            
            statusMessage.className = className;
            statusMessage.textContent = message;
            statusDiv.style.display = 'block';
            
            if (type !== 'info') {
                setTimeout(() => { 
                    statusDiv.style.display = 'none'; 
                }, 5000);
            }
        }
    </script>
</body>
</html>
